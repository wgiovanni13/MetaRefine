// ========================================
// Nextflow Configuration
// ========================================

profiles {
    standard {
        process.executor = 'local'
    }
    
    slurm {
        process {
            executor = 'slurm'
            queue    = 'c'
            clusterOptions = '--qos=long'
            
            // ========================================
            // STAGE 1: Gene Prediction
            // ========================================
            
            withName: GENEMARK {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: GLIMMER {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: PRODIGAL {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: PROKKA {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            // ========================================
            // STAGE 2: Clean and Analyze GFFs
            // ========================================
            
            withName: CLEAN_GFF {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: ANALYZE_GFF {
                cpus   = 2
                memory = '8 GB'
                time   = '4h'
            }
            
            // ========================================
            // STAGE 3: Categorize Ranges
            // ========================================
            
            withName: CATEGORIZE_RANGES {
                cpus   = 1
                memory = '8 GB'
                time   = '1h'
            }
            
            // ========================================
            // STAGE 4: Process Category 3
            // ========================================
            
            withName: EXTRACT_CAT3_SEQUENCES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: TRANSLATE_6FRAMES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: FILTER_ONE_STOP_FRAMES {
                cpus   = 1
                memory = '2 GB'
                time   = '1h'
            }
            
            // ========================================
            // STAGE 5: HHpred Analysis
            // ========================================
            
            withName: SPLIT_FASTA_ONESTOP {
                cpus   = 1
                memory = '2 GB'
                time   = '1h'
            }

            withName: HHPRED {
                cpus   = 2
                memory = '64 GB'
                time   = '48h'
                maxForks = 30
            }
            
            withName: GROUP_HHR_FILES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: SELECT_BEST_QUERY {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: ANALYZE_SINGLES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: FILTER_SINGLES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            // ========================================
            // STAGE 6: Merge and Correct Frames
            // ========================================
            
            withName: MERGE_FINAL_RANGES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: EXTRACT_UNKNOWN_FRAME_RANGES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: TRANSLATE_UNKNOWN_FRAMES_6FRAMES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: IDENTIFY_CORRECT_FRAMES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: UPDATE_MERGED_RANGES_WITH_FRAMES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            // ========================================
            // STAGE 7: Extract Final Sequences
            // ========================================
            
            withName: EXTRACT_FINAL_SEQUENCES {
                cpus   = 1
                memory = '2 GB'
                time   = '1h'
            }
            
            // ========================================
            // STAGE 8: Frameshift Detection (BLAST)
            // ========================================
            
            withName: BLAST_ALL_VS_ALL {
                cpus   = 2
                memory = '4 GB'
                time   = '2h'
            }
            
            withName: DETECT_FRAMESHIFTS {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            // ========================================
            // STAGE 9: Translate to Proteins
            // ========================================
            
            withName: TRANSLATE_FINAL_RANGES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: EXTRACT_FINAL_FRAME {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            // ========================================
            // STAGE 10: Frameshift Detection (DIAMOND)
            // ========================================
            
            withName: PREPARE_DIAMOND_DB {
                cpus   = 2
                memory = '16 GB'
                time   = '8h'
            }
            
            withName: SPLIT_PROTEINS_BY_SIZE {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: DIAMOND_VS_UNIREF90_OPTIMIZED {
                cpus   = 16
                memory = '48 GB'
                time   = '48h'
                maxForks = 10  
            }
            
            withName: PREPARE_DIAMOND_RESULTS {
                cpus   = 2
                memory = '4 GB'
                time   = '2h'
            }
            
            withName: DETECT_FRAMESHIFTS_PER_CHUNK {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            withName: MERGE_FRAMESHIFT_RESULTS {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
            
            // ========================================
            // STAGE 11: New Functional Genes Discovery
            // ========================================
            
            withName: FIND_NEW_FUNCTIONAL_GENES {
                cpus   = 1
                memory = '8 GB'
                time   = '1h'
            }
            
            withName: SUMMARIZE_ALL_NEW_GENES {
                cpus   = 1
                memory = '4 GB'
                time   = '1h'
            }
        }
    }
}

// ========================================
// Global process defaults (fallback)
// ========================================

process {
    executor = 'slurm'
    queue    = 'c'
    clusterOptions = '--qos=medium'
    
    // Default error strategy
    errorStrategy = 'retry'
    maxRetries = 2
    
    // Default scratch
    scratch = true
}

// ========================================
// Nextflow settings
// ========================================

executor {
    name = 'slurm'
    queueSize = 100  
    submitRateLimit = '10 sec' 
    pollInterval = '30 sec'  
}

// Enable trace and reports
trace {
    enabled = true
    file = 'pipeline_trace.txt'
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

report {
    enabled = true
    file = 'pipeline_report.html'
    overwrite = true
}

timeline {
    enabled = true
    file = 'pipeline_timeline.html'
    overwrite = true
}

dag {
    enabled = false
    file = 'pipeline_dag.svg'
    overwrite = true
}

// ========================================
// Work directory cleanup
// ========================================

cleanup = false  // Set to true to auto-delete work/ on successful completion

// ========================================
// Pipeline Parameters
// ========================================

params {
    // HHpred chunk size (sequences per chunk)
    hhpred_chunk_size = 50
    
    // Other parameters are defined in main.nf
}

// ========================================
// Conda/Container settings (if needed)
// ========================================

// singularity {
//     enabled = false
//     autoMounts = true
// }

// conda {
//     enabled = false
//     cacheDir = "$HOME/.nextflow-conda-cache"
// }

